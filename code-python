import tkinter as tk
from tkinter import messagebox
from PIL import Image, ImageTk
import subprocess
import os
import time
import psutil
from pypresence import Presence  # Đã chuyển sang pypresence

version_new = "2.1.4"      # Phiên bản mới (giả định)

def compare_versions(version_current, version_new):
    try:
        # Chuyển đổi phiên bản thành danh sách số nguyên để dễ so sánh
        current_parts = list(map(int, version_current.split(".")))
        new_parts = list(map(int, version_new.split(".")))

        # So sánh từng phần tử của phiên bản
        if new_parts > current_parts:
            messagebox.showinfo(f"Phiên bản mới ({version_new}) lớn hơn phiên bản hiện tại ({version_current}).")
        elif new_parts < current_parts:
            messagebox.showinfo(f"Phiên bản hiện tại ({version_current}) đã lớn hơn phiên bản mới ({version_new}).")
        else:
            messagebox.showinfo("Đúng Phiên Bản.")

# Gọi hàm so sánh
compare_versions(version_current, version_new)


# Thay thế Client ID của bạn ở đây
client_id = '1305854246142476299'
rpc = Presence(client_id)  # Khởi tạo client Rich Presence

def connect_discord_rpc():
    try:
        rpc.connect()
        print("Đã kết nối tới Discord")
        return True
    except Exception as e:
        print(f"Không thể kết nối Discord Rich Presence: {e}")
        return False

def set_rich_presence():
    try:
        # Cập nhật trạng thái Rich Presence
        rpc.update(
            details="PVZ Fusion Việt Hóa By CBD Team",  # Mô tả hiện tại
            start=time.time(),  # Thời gian bắt đầu thực
            large_image="embedded_background",  # Key của hình ảnh lớn (phải được tải lên Discord)
            large_text="LanPiaoPiao (BlueFly)",  # Văn bản khi di chuột vào ảnh lớn
            party_id="ae488379-351d-4a4f-ad32-2b9b01c91657",  # ID của nhóm (nếu có)
            join="MTI4NzM0OjFpMmhuZToxMjMxMjM="  # Chuỗi bí mật để tham gia
        )
        print("Rich Presence đã được thiết lập.")
    except Exception as e:
        print(f"Không thể thiết lập Rich Presence: {e}")

def open_exe_and_quit():
    # Mở ứng dụng PlantsVsZombiesRH.exe mà không hiển thị cửa sổ
    subprocess.Popen("PlantsVsZombiesRH.exe --melonloader.hideconsole", creationflags=subprocess.CREATE_NO_WINDOW)

    # Đóng cửa sổ Tkinter sau khi mở ứng dụng
    root.destroy()
    
    # Chỉ thiết lập Rich Presence nếu kết nối thành công
    if connect_discord_rpc():
        set_rich_presence()

    # Kiểm tra tiến trình của PVZ
    check_pvz_process()

def is_pvz_running():
    # Kiểm tra xem tiến trình "PlantsVsZombiesRH.exe" có đang chạy không
    for proc in psutil.process_iter(['pid', 'name']):
        print(f"Đang kiểm tra tiến trình: {proc.info['name']}")  # In ra tên tiến trình để kiểm tra
        if proc.info['name'] == 'PlantsVsZombiesRH.exe':
            return True
    return False

def check_pvz_process():
    # Kiểm tra và in ra trạng thái của tiến trình "PlantsVsZombiesRH.exe"
    while is_pvz_running():
        time.sleep(1)  # Dừng lại một giây trước khi kiểm tra lại

# Tạo giao diện Tkinter
root = tk.Tk()
root.title("Thông báo")
root.geometry("1000x630")

# Thiết lập icon cửa sổ (ICO)
try:
    root.iconbitmap("icon.ico")  # Đảm bảo rằng icon.ico tồn tại trong thư mục hiện tại
except Exception as e:
    print(f"Lỗi khi thiết lập icon: {e}")

# Hiển thị hình ảnh
try:
    image_path = "./image.png"  # Đảm bảo rằng hình ảnh tồn tại trong thư mục hiện tại
    image = Image.open(image_path)
    image = image.resize((960, 540), Image.LANCZOS)
    photo = ImageTk.PhotoImage(image)
    label = tk.Label(root, image=photo)
    label.pack(pady=10)
except Exception as e:
    print(f"Lỗi khi tải ảnh: {e}")

# Nút bấm "Tiếp Tục"
button = tk.Button(root, text="Tiếp Tục", command=open_exe_and_quit)
button.pack(pady=10)

# Chạy giao diện Tkinter
root.mainloop()
